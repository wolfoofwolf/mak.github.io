<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æº«æ¿•åº¦èˆ‡ç«ç„°ç›£æ§ç³»çµ±</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #111; color: #eee;
            min-height: 100vh;
        }
        .top-bar {
            background: #1a1a1a; padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6);
        }
        .menu-btn { font-size: 1.8rem; cursor: pointer; color: #eee; }
        .title { font-size: 1.4rem; margin: 0; }
        .container {
            max-width: 500px; margin: 30px auto;
            background: #1a1a1a; border-radius: 12px; padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }
        .data-box {
            background: #222; border-radius: 10px; padding: 20px; margin: 15px 0;
            font-size: 1.4rem;
        }
        .temp { color: #ff9800; }
        .humid { color: #4fc3f7; }
        .flame-normal { background: #222; color: #4caf50; }
        .flame-alert { background: #b71c1c; color: white; font-weight: bold; }
        .time { font-size: 0.9rem; color: #888; margin-top: 20px; }
        .buttons { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        button {
            padding: 12px 24px; font-size: 1rem; border: none; border-radius: 8px;
            cursor: pointer; background: #333; color: white; transition: all 0.2s;
        }
        button:hover { background: #555; }
        button:active { transform: scale(0.98); }
        .auto-mode { background: #2196f3; }
        .all-off { background: #757575; }
        .version {
            position: fixed; bottom: 10px; right: 20px; font-size: 0.8rem;
            color: #555; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;
        }
        /* Sidebar */
        .sidebar {
            height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0;
            background: #111; overflow-x: hidden; transition: 0.5s; padding-top: 60px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.8);
        }
        .sidebar a {
            padding: 15px 30px; font-size: 1.2rem; color: #ccc; display: block;
            cursor: pointer;
        }
        .sidebar a:hover { color: #f1f1f1; }
        .closebtn { position: absolute; top: 10px; right: 25px; font-size: 36px; }
        /* Modal */
        .actions-modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto;
        }
        .actions-content {
            background: #161b22; margin: 5% auto; width: 90%; max-width: 900px;
            border-radius: 12px; padding: 25px;
        }
        .actions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-box { width: 60%; padding: 10px; background: #21262d; border: 1px solid #30363d; border-radius: 6px; color: #c9d1d9; }
        .add-btn { background: #238636; padding: 10px 18px; font-size: 0.95rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #30363d; }
        th { background: #21262d; color: #8b949e; }
        .action-btn {
            padding: 6px 14px;
            margin: 0 4px;
            font-size: 0.9rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .edit-btn { background: #3b82f6; }
        .delete-btn { background: #ef4444; }
        .duplicate-btn { background: #6b7280; }
        .test-btn { background: #10b981; }
        .clear-log-btn { background: #b71c1c; margin-top: 15px; padding: 10px 20px; }
        .log-entry {
            padding: 10px; border-bottom: 1px solid #30363d; font-size: 0.95rem;
        }
        .log-time { color: #888; font-size: 0.85rem; }
        .log-action { font-weight: bold; color: #4fc3f7; }
        .log-detail { color: #ccc; }
        /* ç¾åŒ–è¼¸å…¥æ¡† */
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #d1d5db;
            font-size: 0.95rem;
        }
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            color: #e5e7eb;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .input-group input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
            background: #1e293b;
        }
        .input-group input::placeholder { color: #6b7280; }
        /* Charts Modal æ¨£å¼ */
        .chart-modal-content {
            background: #161b22;
            margin: 5% auto;
            width: 90%;
            max-width: 1000px;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        .chart-modal-content h2 {
            color: #ff9800;
            margin-bottom: 20px;
        }
        .chart-container {
            margin: 30px 0;
        }
        .chart-container h4 {
            color: #ff9800;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="top-bar">
    <div class="menu-btn" onclick="openMenu()">â˜°</div>
    <h1 class="title">æº«æ¿•åº¦èˆ‡ç«ç„°ç›£æ§ç³»çµ±</h1>
    <div></div>
</div>

<div class="container">
    <div class="data-box"><span class="temp" id="tempDisplay">Temperature: -- Â°C ğŸŒ¡ï¸</span></div>
    <div class="data-box"><span class="humid" id="humidDisplay">Humidity: -- % ğŸ’§</span></div>
    <div class="data-box" id="flameBox"><span id="flameDisplay">Flame Status: -- ğŸ”¥</span></div>
    <div class="time" id="updateTime">Last updated: loading...</div>
    <div class="buttons">
        <button onclick="updateData()">Refresh Data</button>
        <button class="auto-mode" onclick="controlLed('auto', 1)">Restore Auto Mode</button>
        <button class="all-off" onclick="controlLed('all', 0)">All Light OFF</button>
    </div>
</div>

<div class="version">Version: v2.1 - 2026/02/12</div>

<!-- Notifications Rule Modal -->
<div id="notificationsRuleModal" class="actions-modal">
    <div class="actions-content">
        <div class="actions-header">
            <h2 style="margin:0;">Notifications Rule</h2>
            <button onclick="closeNotificationsRuleModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <div class="input-group">
            <label>æº«åº¦è¶…é (Â°C) æ™‚é€šçŸ¥</label>
            <input type="number" id="tempThreshold" placeholder="ä¾‹å¦‚ 30" step="0.1">
        </div>
        <div class="input-group">
            <label>æ¿•åº¦ä½æ–¼ (%) æ™‚é€šçŸ¥</label>
            <input type="number" id="humidThreshold" placeholder="ä¾‹å¦‚ 40" step="0.1">
        </div>
        <div class="input-group">
            <label>é€šçŸ¥ Email</label>
            <input type="email" id="notifyEmail" placeholder="makmingkit144@gmail.com">
        </div>
        <button onclick="saveNotificationsRule()" style="background:#238636; padding:12px 20px; width:100%; margin-top:20px;">å„²å­˜è¦å‰‡</button>
    </div>
</div>

<!-- Actions Modal -->
<div id="actionsModal" class="actions-modal">
    <div class="actions-content">
        <div class="actions-header">
            <h2 style="margin:0;">Actions</h2>
            <button onclick="closeActionsModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <div style="margin-bottom:15px;">
            <input type="text" id="searchAction" placeholder="Search..." class="search-box">
            <button onclick="addSNMPTrap()" class="add-btn">+ ADD</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Action Type</th>
                    <th>Action Name</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody id="actionList"></tbody>
        </table>
    </div>
</div>

<!-- Log Modal -->
<div id="logModal" class="actions-modal">
    <div class="actions-content">
        <div class="actions-header">
            <h2 style="margin:0;">System Log</h2>
            <button onclick="closeLogModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <button class="clear-log-btn" onclick="clearLog()">Clear All Logs</button>
        <div id="logList" style="margin-top:15px; max-height:60vh; overflow-y:auto;"></div>
    </div>
</div>

<!-- Charts Modal -->
<div id="chartsModal" class="actions-modal">
    <div class="chart-modal-content">
        <div class="actions-header">
            <h2 style="margin:0; color:#ff9800;">æ•¸æ“šåœ–è¡¨</h2>
            <button onclick="closeChartsModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <div class="chart-container">
            <h4>Field 1 Chart (DHT11 æº«åº¦)</h4>
            <iframe 
                width="100%" 
                height="340" 
                style="border: none; background: #111111;" 
                src="https://thingspeak.com/channels/3252434/charts/1?bgcolor=%23111111&color=%23ff9800&dynamic=true&results=60&timescale=10&title=DHT11%20æº«åº¦&type=line&xaxis=Date&yaxis=Temperature%20(Â°C)&yaxismax=40&yaxismin=10&showlegend=false&showxaxislabel=true&showyaxislabel=true">
            </iframe>
        </div>
        <div class="chart-container">
            <h4>Field 2 Chart (DHT11 æ¿•åº¦)</h4>
            <iframe 
                width="100%" 
                height="340" 
                style="border: none; background: #111111;" 
                src="https://thingspeak.com/channels/3252434/charts/2?bgcolor=%23111111&color=%234fc3f7&dynamic=true&results=60&timescale=10&title=DHT11%20æ¿•åº¦&type=line&xaxis=Date&yaxis=Humidity%20(%)&yaxismax=100&yaxismin=0&showlegend=false&showxaxislabel=true&showyaxislabel=true">
            </iframe>
        </div>
        <p style="text-align: center; margin-top: 20px; color: #888;">è³‡æ–™ä¾†è‡ª ThingSpeak</p>
    </div>
</div>

<!-- Edit Email Modal -->
<div id="editEmailModal" class="actions-modal">
    <div class="actions-content">
        <h2 style="margin-top:0;">Edit Email Settings for Action</h2>
        <div class="input-group">
            <label>From Email (Sender)</label>
            <input type="email" id="fromEmail" placeholder="yourname@example.com">
        </div>
        <div class="input-group">
            <label>To Email (Receiver)</label>
            <input type="email" id="toEmail" placeholder="makmingkit144@gmail.com">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button onclick="saveActionEmail()" style="flex: 1; background:#238636; padding:12px; border-radius:6px;">Save</button>
            <button onclick="closeEditEmailModal()" style="flex: 1; background:#f44336; padding:12px; border-radius:6px;">Cancel</button>
        </div>
    </div>
</div>

<script>
// EmailJS åˆå§‹åŒ–
emailjs.init("DesLsbj7IJqknmZFq");

// Log ç³»çµ±
let logEntries = JSON.parse(localStorage.getItem("systemLog")) || [];
function addLog(action, details = "") {
    const entry = {
        time: new Date().toLocaleString('zh-TW'),
        action: action,
        details: details
    };
    logEntries.unshift(entry);
    localStorage.setItem("systemLog", JSON.stringify(logEntries));
    renderLogList();
}
function clearLog() {
    if (confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ—¥èªŒå—ï¼Ÿ")) {
        logEntries = [];
        localStorage.removeItem("systemLog");
        renderLogList();
        addLog("ç³»çµ±æ—¥èªŒå·²å…¨éƒ¨æ¸…é™¤");
    }
}
function renderLogList() {
    const container = document.getElementById("logList");
    let html = "";
    if (logEntries.length === 0) {
        html = "<p style='color:#888; text-align:center;'>ç›®å‰æ²’æœ‰æ—¥èªŒ</p>";
    } else {
        logEntries.forEach(entry => {
            html += `
                <div class="log-entry">
                    <div class="log-time">${entry.time}</div>
                    <div class="log-action">${entry.action}</div>
                    ${entry.details ? `<div class="log-detail">${entry.details}</div>` : ""}
                </div>`;
        });
    }
    container.innerHTML = html;
}

// Sidebar æ§åˆ¶
function openMenu() { document.getElementById("sidebar").style.width = "280px"; }
function closeMenu() { document.getElementById("sidebar").style.width = "0"; }

// Notifications Rule Modal
let notificationsRule = JSON.parse(localStorage.getItem("notificationsRule")) || {
  tempThreshold: null,
  humidThreshold: null,
  notifyEmail: ""
};

function showNotificationsRule() {
  closeMenu();
  document.getElementById("notificationsRuleModal").style.display = "block";
  
  document.getElementById("tempThreshold").value = notificationsRule.tempThreshold || "";
  document.getElementById("humidThreshold").value = notificationsRule.humidThreshold || "";
  document.getElementById("notifyEmail").value = notificationsRule.notifyEmail || "";
  addLog("é–‹å•Ÿ Notifications Rule é¢æ¿");
}

function closeNotificationsRuleModal() {
  document.getElementById("notificationsRuleModal").style.display = "none";
}

function saveNotificationsRule() {
  const temp = document.getElementById("tempThreshold").value;
  const humid = document.getElementById("humidThreshold").value;
  const email = document.getElementById("notifyEmail").value;

  notificationsRule = {
    tempThreshold: temp ? Number(temp) : null,
    humidThreshold: humid ? Number(humid) : null,
    notifyEmail: email
  };

  localStorage.setItem("notificationsRule", JSON.stringify(notificationsRule));
  addLog("å„²å­˜é€šçŸ¥è¦å‰‡", `æº«åº¦ > ${temp || '--'} Â°C, æ¿•åº¦ < ${humid || '--'} %, Email: ${email}`);
  alert("è¦å‰‡å·²å„²å­˜ï¼ç¶²é æœƒè‡ªå‹•ç›£æ§ä¸¦ç™¼é€é€šçŸ¥");
  closeNotificationsRuleModal();
}

// Charts Modal
function showCharts() {
  closeMenu();
  document.getElementById("chartsModal").style.display = "block";
  addLog("é–‹å•Ÿæ•¸æ“šåœ–è¡¨");
}

function closeChartsModal() {
  document.getElementById("chartsModal").style.display = "none";
}

// Actions Modal
function showActions() {
  closeMenu();
  document.getElementById("actionsModal").style.display = "block";
  renderActionList();
  addLog("é–‹å•Ÿ Actions é¢æ¿");
}
function closeActionsModal() {
  document.getElementById("actionsModal").style.display = "none";
}

// Log Modal
function showLog() {
  closeMenu();
  renderLogList();
  document.getElementById("logModal").style.display = "block";
}
function closeLogModal() {
  document.getElementById("logModal").style.display = "none";
}

// Email settings modal
function openEditEmailModal(id) {
  document.getElementById("editEmailModal").style.display = "block";
  window.currentEditId = id;
  const action = actions.find(a => a.id === id);
  document.getElementById("fromEmail").value = action.fromEmail || "";
  document.getElementById("toEmail").value = action.toEmail || "";
}
function closeEditEmailModal() {
  document.getElementById("editEmailModal").style.display = "none";
}
function saveActionEmail() {
  const id = window.currentEditId;
  const action = actions.find(a => a.id === id);
  const from = document.getElementById("fromEmail").value;
  const to = document.getElementById("toEmail").value;
 
  action.fromEmail = from;
  action.toEmail = to;
  saveActions();
 
  addLog("æ›´æ–° Email è¨­å®š", `Action: ${action.name} | From: ${from} | To: ${to}`);
  alert("Email è¨­å®šå·²å„²å­˜");
  closeEditEmailModal();
}

// Actions management
let actions = JSON.parse(localStorage.getItem("actions")) || [
  { id: 1, type: "SNMP Trap", name: "SNMP Trap Action 1", fromEmail: "", toEmail: "" }
];
function saveActions() {
  localStorage.setItem("actions", JSON.stringify(actions));
}
function renderActionList() {
  let html = "";
  actions.forEach(a => {
    html += `
      <tr class="action-row">
        <td>${a.type}</td>
        <td>${a.name}</td>
        <td style="text-align:right;">
          <button class="action-btn edit-btn" onclick="openEditEmailModal(${a.id})">Edit</button>
          <button class="action-btn delete-btn" onclick="deleteAction(${a.id})">Delete</button>
          <button class="action-btn duplicate-btn" onclick="duplicateAction(${a.id})">Duplicate</button>
          <button class="action-btn test-btn" onclick="testAction(${a.id})">Test</button>
        </td>
      </tr>`;
  });
  document.getElementById("actionList").innerHTML = html;
}
function addSNMPTrap() {
  const name = prompt("è¼¸å…¥ SNMP Trap Action åç¨±:", "SNMP Trap Action " + (actions.length + 1));
  if (name) {
    const newAction = { id: Date.now(), type:"SNMP Trap", name, fromEmail: "", toEmail: "" };
    actions.push(newAction);
    saveActions();
    renderActionList();
    addLog("æ–°å¢ Action", name);
  }
}
function deleteAction(id) {
  if (confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) {
    const action = actions.find(a => a.id === id);
    actions = actions.filter(a => a.id !== id);
    saveActions();
    renderActionList();
    addLog("åˆªé™¤ Action", action ? action.name : "æœªçŸ¥");
  }
}
function duplicateAction(id) {
  const action = actions.find(a => a.id === id);
  if (action) {
    actions.push({
      id: Date.now(),
      type: action.type,
      name: action.name + " (è¤‡è£½)",
      fromEmail: action.fromEmail,
      toEmail: action.toEmail
    });
    saveActions();
    renderActionList();
    addLog("è¤‡è£½ Action", action.name);
  }
}
function testAction(id) {
  const action = actions.find(a => a.id === id);
  const toEmail = action.toEmail || prompt("è¼¸å…¥æ”¶ä»¶äºº Email:", "makmingkit144@gmail.com");
  if (!toEmail) return;
  addLog("æ¸¬è©¦ Action - æº–å‚™ç™¼é€ Email", `Action: ${action.name} | æ”¶ä»¶äºº: ${toEmail}`);
  emailjs.send("FYP", "FYP", {
    to_email: toEmail,
    subject: "SNMP Trap Alert: " + action.name + " (æ¸¬è©¦)",
    action_name: action.name,
    action_type: action.type,
    time: new Date().toLocaleString('zh-TW'),
    message: "é€™æ˜¯ä¸€å°æ¸¬è©¦é€šçŸ¥ã€‚\n\n" +
             "æº«åº¦: " + document.getElementById('tempDisplay').textContent + "\n" +
             "æ¿•åº¦: " + document.getElementById('humidDisplay').textContent + "\n" +
             "ç«ç„°ç‹€æ…‹: " + document.getElementById('flameDisplay').textContent
  }).then(() => {
    addLog("Email ç™¼é€æˆåŠŸ", `æ¸¬è©¦ Action: ${action.name} â†’ ${toEmail}`);
    alert("æ¸¬è©¦ Email å·²ç™¼é€åˆ° " + toEmail);
  }).catch((err) => {
    addLog("Email ç™¼é€å¤±æ•—", `éŒ¯èª¤: ${err.text || err}`);
    alert("ç™¼é€å¤±æ•—: " + (err.text || err));
  });
}

// å…¶ä»–åŠŸèƒ½
function updateData() {
  addLog("æ‰‹å‹•åˆ·æ–°è³‡æ–™");
  fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1/last.json?api_key=${readAPIKey}`)
    .then(r => r.json())
    .then(d => {
      const temp = d.field1 ? Number(d.field1).toFixed(1) : '--';
      document.getElementById('tempDisplay').textContent = `Temperature: ${temp} Â°C ğŸŒ¡ï¸`;
    });
  fetch(`https://api.thingspeak.com/channels/${channelID}/fields/2/last.json?api_key=${readAPIKey}`)
    .then(r => r.json())
    .then(d => {
      const humid = d.field2 ? Number(d.field2).toFixed(1) : '--';
      document.getElementById('humidDisplay').textContent = `Humidity: ${humid} % ğŸ’§`;
    });
  fetch(`https://api.thingspeak.com/channels/${channelID}/fields/3/last.json?api_key=${readAPIKey}`)
    .then(r => r.json())
    .then(d => {
      const flame = d.field3;
      let text = '--';
      let cls = 'flame-normal';
      if (flame == 0) {
        text = "Flame Detected! ğŸ”¥";
        cls = 'flame-alert';
      } else if (flame == 1) {
        text = "No Flame âœ…";
        cls = 'flame-normal';
      }
      document.getElementById('flameDisplay').textContent = `Flame Status: ${text}`;
      document.getElementById('flameBox').className = 'data-box ' + cls;
    });
  document.getElementById('updateTime').textContent =
    `Last updated: ${new Date().toLocaleString('zh-TW')}`;
}
function controlLed(type, state) {
  addLog("LED æ§åˆ¶", `type=${type}, state=${state}`);
  fetch(`${espIP}/led?type=${type}&state=${state}`)
    .then(response => {
      if (!response.ok) throw new Error('HTTP ' + response.status);
      return response.text();
    })
    .then(text => {
      console.log("LED æ§åˆ¶æˆåŠŸ:", text);
    })
    .catch(err => {
      console.error("LED æ§åˆ¶å¤±æ•—:", err);
    });
}

// Auto update
const channelID = 3252434;
const readAPIKey = "PKQNQOPCZYREXB6C";
const espIP = "http://192.168.1.157";  // â† æ”¹æˆä½ ä¸» ESP32 çš„ IP
setInterval(() => {
  addLog("è‡ªå‹•åˆ·æ–°è³‡æ–™ (æ¯ 20 ç§’)");
  updateData();
}, 20000);
updateData();
</script>
</body>
</html>
