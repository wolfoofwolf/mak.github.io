<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æº«æ¿•åº¦èˆ‡ç«ç„°ç›£æ§</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body { margin:0; padding:0; font-family:system-ui,sans-serif; background:#111; color:#eee; min-height:100vh; }
        .top-bar { background:#1a1a1a; padding:15px 20px; display:flex; align-items:center; justify-content:space-between; box-shadow:0 2px 10px rgba(0,0,0,0.6); }
        .menu-btn { font-size:1.8rem; cursor:pointer; color:#eee; }
        .title { font-size:1.4rem; margin:0; }
        .container { max-width:500px; margin:30px auto; background:#1a1a1a; border-radius:12px; padding:30px; box-shadow:0 4px 20px rgba(0,0,0,0.6); }
        .data-box { background:#222; border-radius:10px; padding:20px; margin:15px 0; font-size:1.4rem; }
        .temp { color:#ff9800; }
        .humid { color:#4fc3f7; }
        .flame-normal { background:#222; color:#4caf50; }
        .flame-alert { background:#b71c1c; color:white; font-weight:bold; }
        .time { font-size:0.9rem; color:#888; margin-top:20px; }
        .buttons { display:flex; justify-content:center; gap:15px; margin-top:30px; flex-wrap:wrap; }
        button { padding:12px 24px; font-size:1rem; border:none; border-radius:8px; cursor:pointer; background:#333; color:white; transition:all 0.2s; }
        button:hover { background:#555; }
        .auto-mode { background:#2196f3; }
        .all-off { background:#757575; }
        .version { position:fixed; bottom:10px; right:20px; font-size:0.8rem; color:#555; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px; }

        .sidebar { height:100%; width:0; position:fixed; z-index:10; top:0; left:0; background:#111; overflow-x:hidden; transition:0.5s; padding-top:60px; box-shadow:2px 0 10px rgba(0,0,0,0.8); }
        .sidebar a { padding:15px 30px; font-size:1.2rem; color:#ccc; display:block; }
        .sidebar a:hover { color:#f1f1f1; }
        .closebtn { position:absolute; top:10px; right:25px; font-size:36px; }

        .modal { display:none; position:fixed; z-index:30; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.85); }
        .modal-content { background:#161b22; margin:10% auto; width:90%; max-width:500px; border-radius:12px; padding:25px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="menu-btn" onclick="openMenu()">â˜°</div>
    <h1 class="title">æº«æ¿•åº¦èˆ‡ç«ç„°ç›£æ§</h1>
    <div></div>
</div>

<div id="sidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeMenu()">Ã—</a>
    <a href="#" onclick="showNotificationRules()">Notification Rules</a>
    <a href="#" onclick="showActions()">Actions</a>
</div>

<div class="container">
    <div class="data-box"><span class="temp" id="tempDisplay">Temperature: -- Â°C ğŸŒ¡ï¸</span></div>
    <div class="data-box"><span class="humid" id="humidDisplay">Humidity: -- % ğŸ’§</span></div>
    <div class="data-box" id="flameBox"><span id="flameDisplay">Flame Status: -- ğŸ”¥</span></div>
    <div class="time" id="updateTime">Last updated: loading...</div>

    <div class="buttons">
        <button onclick="updateData()">Refresh Data</button>
        <button class="auto-mode" onclick="controlLed('auto', 1)">Restore Auto Mode</button>
        <button class="all-off" onclick="controlLed('all', 0)">All Light OFF</button>
    </div>
</div>

<div class="version">ç‰ˆæœ¬ï¼šv2.2 - 2026/02/06</div>

<!-- Notification Rules å°è¦–çª— -->
<div id="rulesModal" class="modal">
    <div class="modal-content">
        <h2>Notification Rules</h2>
        <p>ç•¶æº«åº¦é€²å…¥ä»¥ä¸‹ç¯„åœæ™‚è‡ªå‹•ç™¼é€ Email</p>
        
        <label><input type="checkbox" id="nr_range1"> 0 - 20 Â°C</label><br>
        <label><input type="checkbox" id="nr_range2"> 20 - 30 Â°C</label><br>
        <label><input type="checkbox" id="nr_range3"> 30 - 35 Â°C</label><br><br>

        <button onclick="saveNotificationRule()" style="background:#238636; width:100%; padding:12px;">å„²å­˜è¦å‰‡</button>
        <button onclick="closeRulesModal()" style="background:#f44336; width:100%; padding:12px; margin-top:10px;">å–æ¶ˆ</button>
    </div>
</div>

<script>
// EmailJS åˆå§‹åŒ–
emailjs.init("DesLsbj7IJqknmZFq");

// å´é‚Šæ¬„
function openMenu() { document.getElementById("sidebar").style.width = "280px"; }
function closeMenu() { document.getElementById("sidebar").style.width = "0"; }

// Notification Rules å°è¦–çª—
function showNotificationRules() {
    closeMenu();
    document.getElementById("rulesModal").style.display = "block";

    // è¼‰å…¥å·²å„²å­˜ç‹€æ…‹
    document.getElementById("nr_range1").checked = localStorage.getItem("nr_range1") === "true";
    document.getElementById("nr_range2").checked = localStorage.getItem("nr_range2") === "true";
    document.getElementById("nr_range3").checked = localStorage.getItem("nr_range3") === "true";
}

function closeRulesModal() {
    document.getElementById("rulesModal").style.display = "none";
}

function saveNotificationRule() {
    localStorage.setItem("nr_range1", document.getElementById("nr_range1").checked);
    localStorage.setItem("nr_range2", document.getElementById("nr_range2").checked);
    localStorage.setItem("nr_range3", document.getElementById("nr_range3").checked);
    alert("è¦å‰‡å·²å„²å­˜ï¼ç•¶æº«åº¦é€²å…¥å‹¾é¸ç¯„åœæ™‚æœƒè‡ªå‹•ç™¼é€ Email");
    closeRulesModal();
}

// è‡ªå‹•æª¢æŸ¥æº«åº¦ä¸¦ç™¼ Email
function checkNotificationRule(temp) {
    const r1 = localStorage.getItem("nr_range1") === "true";
    const r2 = localStorage.getItem("nr_range2") === "true";
    const r3 = localStorage.getItem("nr_range3") === "true";

    let trigger = false;
    let range = "";
    if (r1 && temp < 20) { trigger = true; range = "0-20Â°C"; }
    else if (r2 && temp >= 20 && temp < 30) { trigger = true; range = "20-30Â°C"; }
    else if (r3 && temp >= 30 && temp <= 35) { trigger = true; range = "30-35Â°C"; }

    if (trigger) {
        emailjs.send("FYP", "FYP", {
            to_email: "makmingkit144@gmail.com",
            subject: "æº«åº¦è­¦å ±è§¸ç™¼ï¼",
            message: `ç›®å‰æº«åº¦ï¼š${temp}Â°C å·²é€²å…¥æ‚¨è¨­å®šçš„ç¯„åœ (${range})\nè«‹ç«‹å³æª¢æŸ¥ç³»çµ±ï¼`
        });
    }
}

// åŸæœ‰ updateDataï¼ˆåªåŠ ä¸€è¡Œæª¢æŸ¥ï¼‰
const channelID = 3252434;
const readAPIKey = "PKQNQOPCZYREXB6C";
const espIP = "http://192.168.1.140";

function updateData() {
    fetch(`https://api.thingspeak.com/channels/${channelID}/fields/1/last.json?api_key=${readAPIKey}`)
        .then(r => r.json())
        .then(d => {
            const temp = d.field1 ? Number(d.field1).toFixed(1) : '--';
            document.getElementById('tempDisplay').textContent = `Temperature: ${temp} Â°C ğŸŒ¡ï¸`;
            if (temp !== '--') checkNotificationRule(parseFloat(temp));   // â† åªåŠ é€™ä¸€è¡Œ
        });

    fetch(`https://api.thingspeak.com/channels/${channelID}/fields/2/last.json?api_key=${readAPIKey}`)
        .then(r => r.json())
        .then(d => {
            const humid = d.field2 ? Number(d.field2).toFixed(1) : '--';
            document.getElementById('humidDisplay').textContent = `Humidity: ${humid} % ğŸ’§`;
        });

    fetch(`https://api.thingspeak.com/channels/${channelID}/fields/3/last.json?api_key=${readAPIKey}`)
        .then(r => r.json())
        .then(d => {
            const flame = d.field3;
            let text = '--';
            let cls = 'flame-normal';
            if (flame == 0) { text = "Flame Detected! ğŸ”¥"; cls = 'flame-alert'; }
            else if (flame == 1) { text = "No Flame âœ…"; cls = 'flame-normal'; }
            document.getElementById('flameDisplay').textContent = `Flame Status: ${text}`;
            document.getElementById('flameBox').className = 'data-box ' + cls;
        });

    document.getElementById('updateTime').textContent = `Last updated: ${new Date().toLocaleString('zh-TW')}`;
}

function controlLed(type, state) {
    fetch(`${espIP}/led?type=${type}&state=${state}`)
        .then(r => r.text())
        .then(text => console.log("æ§åˆ¶æˆåŠŸ: " + text))
        .catch(err => console.error("æ§åˆ¶éŒ¯èª¤:", err));
}

setInterval(updateData, 20000);
updateData();
</script>
</body>
</html>
