<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æº«æ¿•åº¦èˆ‡ç«ç„°ç›£æ§ç³»çµ±</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, sans-serif; background: #111; color: #eee; min-height: 100vh; }
        .top-bar { background: #1a1a1a; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.6); }
        .menu-btn { font-size: 1.8rem; cursor: pointer; color: #eee; }
        .title { font-size: 1.4rem; margin: 0; }
        .container { max-width: 500px; margin: 30px auto; background: #1a1a1a; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        .data-box { background: #222; border-radius: 10px; padding: 20px; margin: 15px 0; font-size: 1.4rem; }
        .temp { color: #ff9800; }
        .humid { color: #4fc3f7; }
        .flame-normal { background: #222; color: #4caf50; }
        .flame-alert { background: #b71c1c; color: white; font-weight: bold; }
        .time { font-size: 0.9rem; color: #888; margin-top: 20px; }
        .buttons { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        button { padding: 12px 24px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; background: #333; color: white; transition: all 0.2s; }
        button:hover { background: #555; }
        button:active { transform: scale(0.98); }
        .auto-mode { background: #2196f3; }
        .all-off { background: #757575; }
        .version { position: fixed; bottom: 10px; right: 20px; font-size: 0.8rem; color: #555; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
        .sidebar { height: 100%; width: 0; position: fixed; z-index: 10; top: 0; left: 0; background: #111; overflow-x: hidden; transition: 0.5s; padding-top: 60px; box-shadow: 2px 0 10px rgba(0,0,0,0.8); }
        .sidebar a { padding: 15px 30px; font-size: 1.2rem; color: #ccc; display: block; cursor: pointer; }
        .sidebar a:hover { color: #f1f1f1; }
        .closebtn { position: absolute; top: 10px; right: 25px; font-size: 36px; }
        .actions-modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; }
        .actions-content { background: #161b22; margin: 5% auto; width: 90%; max-width: 900px; border-radius: 12px; padding: 25px; }
        .actions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #d1d5db; font-size: 0.95rem; }
        .input-group input { width: 100%; padding: 12px 16px; background: #1f2937; border: 1px solid #374151; border-radius: 8px; color: #e5e7eb; font-size: 1rem; }
        .input-group input:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.3); background: #1e293b; }
    </style>
</head>
<body>
<div class="top-bar">
    <div class="menu-btn" onclick="openMenu()">â˜°</div>
    <h1 class="title">æº«æ¿•åº¦èˆ‡ç«ç„°ç›£æ§ç³»çµ±</h1>
    <div></div>
</div>

<div id="sidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeMenu()">Ã—</a>
    <a href="#" onclick="showNotificationsRule()">Notifications Rule</a>
    <a href="#" onclick="showActions()">Actions</a>
    <a href="#" onclick="showLog()">Log</a>
</div>

<div class="container">
    <div class="data-box"><span class="temp" id="tempDisplay">Temperature: -- Â°C ğŸŒ¡ï¸</span></div>
    <div class="data-box"><span class="humid" id="humidDisplay">Humidity: -- % ğŸ’§</span></div>
    <div class="data-box" id="flameBox"><span id="flameDisplay">Flame Status: -- ğŸ”¥</span></div>
    <div class="time" id="updateTime">Last updated: loading...</div>
    <div class="buttons">
        <button onclick="updateData()">Refresh Data</button>
        <button class="auto-mode" onclick="controlLed('auto', 1)">Restore Auto Mode</button>
        <button class="all-off" onclick="controlLed('all', 0)">All Light OFF</button>
    </div>
</div>

<div class="version">Version: v2.1 - 2026/02/12</div>

<!-- Notifications Rule Modal -->
<div id="notificationsRuleModal" class="actions-modal">
    <div class="actions-content">
        <div class="actions-header">
            <h2 style="margin:0;">Notifications Rule</h2>
            <button onclick="closeNotificationsRuleModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <div class="input-group">
            <label>æº«åº¦è¶…é (Â°C) æ™‚é€šçŸ¥</label>
            <input type="number" id="tempThreshold" placeholder="ä¾‹å¦‚ 30" step="0.1">
        </div>
        <div class="input-group">
            <label>æ¿•åº¦ä½æ–¼ (%) æ™‚é€šçŸ¥</label>
            <input type="number" id="humidThreshold" placeholder="ä¾‹å¦‚ 40" step="0.1">
        </div>
        <div class="input-group">
            <label>é€šçŸ¥ Email</label>
            <input type="email" id="notifyEmail" placeholder="makmingkit144@gmail.com">
        </div>
        <button onclick="saveNotificationsRule()" style="background:#238636; padding:12px 20px; width:100%; margin-top:20px;">å„²å­˜è¦å‰‡</button>
    </div>
</div>

<!-- Actions Modal -->
<div id="actionsModal" class="actions-modal">
    <div class="actions-content">
        <div class="actions-header">
            <h2 style="margin:0;">Actions</h2>
            <button onclick="closeActionsModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <div style="margin-bottom:15px;">
            <input type="text" id="searchAction" placeholder="Search..." class="search-box">
            <button onclick="addSNMPTrap()" class="add-btn">+ ADD</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Action Type</th>
                    <th>Action Name</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody id="actionList"></tbody>
        </table>
    </div>
</div>

<!-- Log Modal -->
<div id="logModal" class="actions-modal">
    <div class="actions-content">
        <div class="actions-header">
            <h2 style="margin:0;">System Log</h2>
            <button onclick="closeLogModal()" style="background:#f44336; padding:8px 16px;">Close</button>
        </div>
        <button class="clear-log-btn" onclick="clearLog()">Clear All Logs</button>
        <div id="logList" style="margin-top:15px; max-height:60vh; overflow-y:auto;"></div>
    </div>
</div>

<script>
// EmailJS åˆå§‹åŒ–
emailjs.init("DesLsbj7IJqknmZFq");

// Log ç³»çµ±
let logEntries = JSON.parse(localStorage.getItem("systemLog")) || [];
function addLog(action, details = "") {
    const entry = { time: new Date().toLocaleString('zh-TW'), action, details };
    logEntries.unshift(entry);
    localStorage.setItem("systemLog", JSON.stringify(logEntries));
    renderLogList();
}
function clearLog() {
    if (confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰æ—¥èªŒï¼Ÿ")) {
        logEntries = [];
        localStorage.removeItem("systemLog");
        renderLogList();
    }
}
function renderLogList() {
    const container = document.getElementById("logList");
    container.innerHTML = logEntries.length === 0 ? "<p style='color:#888; text-align:center;'>ç›®å‰æ²’æœ‰æ—¥èªŒ</p>" : logEntries.map(e => `
        <div class="log-entry">
            <div class="log-time">${e.time}</div>
            <div class="log-action">${e.action}</div>
            ${e.details ? `<div class="log-detail">${e.details}</div>` : ""}
        </div>`).join('');
}

// Sidebar æ§åˆ¶
function openMenu() { document.getElementById("sidebar").style.width = "280px"; }
function closeMenu() { document.getElementById("sidebar").style.width = "0"; }

// Notifications Rule
let notificationsRule = JSON.parse(localStorage.getItem("notificationsRule")) || { tempThreshold: null, humidThreshold: null, notifyEmail: "" };

function showNotificationsRule() {
  closeMenu();
  document.getElementById("notificationsRuleModal").style.display = "block";
  document.getElementById("tempThreshold").value = notificationsRule.tempThreshold || "";
  document.getElementById("humidThreshold").value = notificationsRule.humidThreshold || "";
  document.getElementById("notifyEmail").value = notificationsRule.notifyEmail || "";
}

function closeNotificationsRuleModal() { document.getElementById("notificationsRuleModal").style.display = "none"; }

function saveNotificationsRule() {
  const temp = document.getElementById("tempThreshold").value;
  const humid = document.getElementById("humidThreshold").value;
  const email = document.getElementById("notifyEmail").value;

  notificationsRule = {
    tempThreshold: temp ? Number(temp) : null,
    humidThreshold: humid ? Number(humid) : null,
    notifyEmail: email
  };

  localStorage.setItem("notificationsRule", JSON.stringify(notificationsRule));

  // ç™¼ POST çµ¦ ESP32 æ›´æ–°è¦å‰‡
  fetch(`${espIP}/setRule`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `tempThreshold=${temp}&humidThreshold=${humid}&notifyEmail=${encodeURIComponent(email)}`
  }).then(response => response.text())
    .then(text => {
      console.log("è¦å‰‡å·²å‚³çµ¦ ESP32:", text);
      addLog("è¦å‰‡å·²å‚³é€çµ¦ ESP32", text);
      alert("è¦å‰‡å·²å„²å­˜ä¸¦å‚³çµ¦ ESP32ï¼Œå¾Œç«¯æœƒä½¿ç”¨æ­¤å€¼ç™¼é€šçŸ¥");
    }).catch(err => {
      console.error("å‚³é€å¤±æ•—:", err);
      addLog("å‚³é€è¦å‰‡å¤±æ•—", err);
      alert("å‚³é€è¦å‰‡å¤±æ•—ï¼Œè«‹ç¢ºèª ESP32 IP");
    });

  closeNotificationsRuleModal();
}

// Auto æª¢æŸ¥ä¸¦ç™¼ Emailï¼ˆæ¯ 20 ç§’ï¼‰
setInterval(() => {
  if (notificationsRule.notifyEmail === "") return;

  const tempText = document.getElementById('tempDisplay').textContent;
  const humidText = document.getElementById('humidDisplay').textContent;
  const temp = parseFloat(tempText.match(/\d+\.\d+/)?.[0] || 0);
  const humid = parseFloat(humidText.match(/\d+\.\d+/)?.[0] || 0);

  if (notificationsRule.tempThreshold && temp > notificationsRule.tempThreshold) {
    sendNotificationEmail("æº«åº¦è­¦å ±ï¼", `ç›®å‰æº«åº¦: ${temp} Â°Cï¼Œå·²è¶…éè¨­å®šå€¼ ${notificationsRule.tempThreshold} Â°C`);
  }

  if (notificationsRule.humidThreshold && humid < notificationsRule.humidThreshold) {
    sendNotificationEmail("æ¿•åº¦è­¦å ±ï¼", `ç›®å‰æ¿•åº¦: ${humid} %ï¼Œå·²ä½æ–¼è¨­å®šå€¼ ${notificationsRule.humidThreshold} %`);
  }
}, 20000);

function sendNotificationEmail(subject, message) {
  emailjs.send("FYP", "FYP", {
    to_email: notificationsRule.notifyEmail,
    subject: subject,
    message: message + "\n\n" + "æ™‚é–“: " + new Date().toLocaleString('zh-TW')
  }).then(() => {
    console.log("è‡ªå‹•é€šçŸ¥ç™¼é€æˆåŠŸ");
    addLog("è‡ªå‹•é€šçŸ¥ç™¼é€æˆåŠŸ", subject);
  }).catch(err => {
    console.error("è‡ªå‹•é€šçŸ¥ç™¼é€å¤±æ•—:", err);
    addLog("è‡ªå‹•é€šçŸ¥ç™¼é€å¤±æ•—", err);
  });
}

// å…¶ä»–åŸæœ‰åŠŸèƒ½ï¼ˆupdateData, controlLed, Actions, Log ç­‰ï¼‰è«‹ä¿ç•™ä½ åŸæœ¬çš„ script å…§å®¹
// ...
</script>
</body>
</html>
